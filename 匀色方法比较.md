### 卫星影像匀色处理流程

<img src="C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240903103052079.png" alt="image-20240903103052079" style="zoom:50%;" />

### 传统方法【作用 优缺点】

##### 直方图匹配法

`①计算原始影像的累积直方图；②计算参考影像的累积直方图；③利用一定的映射规则，建立原始积累直方图和参考的累积 直方图映射表，再利用该映射表实现原始影像具有和参考影像相似的直方图。`

优点：操作简单，处理速度快，适合大批量数据的快速处理。

缺点：影像存在直方图不连续现象，出现多灰度级合并，对遥感影像的细节反差有影响。直方图匹配法虽然能使不同影像具有与目标影像近似的均值和方差,但当影像间差异过大时容易出现偏色现象【色彩偏移】。

##### 色彩空间变换法

###### 优点：
1. **色彩调整灵活**：通过转换到不同的色彩空间（如LAB、HSV等），可以分别处理亮度、色调和饱和度，提供更多的调节灵活性。
2. **能够保留细节**：在一些色彩空间中（如Lab），能够较好地分离色彩信息和亮度信息，避免过度调整导致细节丢失。
3. **适合视觉一致性**：能快速均衡色彩，使影像视觉上更和谐，适合一些视觉应用，如拼接、融合。

###### 缺点：
1. **无法解决物理因素影响**：仅针对像素的色彩分量进行调整，无法修正由于大气或传感器差异导致的辐射变化。

2. **依赖转换质量**：色彩空间变换本身可能会带来色彩失真，特别是在过度调整的情况下。

3. **对影像要求高**：对原始影像的质量有一定要求，噪声较大的影像在变换过程中可能会放大问题。

   

- [x] ##### *MASK 匀色法( 马斯克匀光法)* 

`模糊正像匀光方法,将原始影像看做光照均匀影像与噪声影像（背景影像）的叠加。`

f(x,y)=r(x,y)+g(x,y)

式中 f(x,y)为原始亮度不均图像，r(x,y)为亮度均匀图像，g(x,y)为反映亮度分布的噪声图像。

通常——高斯低通滤波器获取噪声影像【背景影像】

将原始图像减去噪声图像，最后对运算结果进行拉伸，加强反 差，即可获得亮度均衡的图像。

<img src="C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240903101330232.png" alt="image-20240903101330232" style="zoom:50%;" />

优点：

（1）MASK 匀光法能够保证影像的整体灰度均值。 

（2）噪声影像能反映待处理影像的亮度分布。

缺点：

（1）MASK 匀光法很难确定高斯低通滤波尺度。由于待处理图像与噪声图像需要进行相减处理，而滤波器的尺度大小决定了噪声图像信息量大小，要选择合适 的尺度才能避免过多的信息被删除，从而保证匀光结果影像的质量。 

（2）MASK 匀光法运算效率较低，实际应用中滤波器尺度偏大，导致运算量的 增加，而随着影像尺寸的增加、波段数的增加，运算效率会成比例的降低。

##### 小波变换法

“小波”就是小的波形。所谓“小”是指它具有衰减性；而称之为“波”则是指它的波动性，其振幅正负相间的震荡形式。

"傅里叶升级版"

小波变换是时间（空间）和频率的局部化分析，它通过伸缩平移运算对信号(函数)逐步进行多尺度细化，最终达到高频处时间细分，低频处频率细分，能自动适应时频信号分析的要求，从而可聚焦到信号的任意细节

`对原始卫星影像和基准色调影像进行小波分解，获得相应的高、低频信息，根据高、低频信息将原始卫星影像与基准色调影像进行色彩匹配，最后进行小波重构，获得色彩均衡后的影像。`

<img src="C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240903112523764.png" alt="image-20240903112523764" style="zoom:50%;" />

###### 优点：
1. **多尺度分析**：小波变换可以同时在不同尺度上对影像进行处理，能够更好地处理影像中的局部细节和全局信息，适合应对复杂场景。
2. **高效噪声抑制**：小波变换对影像的噪声较敏感，能够有效区分噪声和图像细节，从而减少匀色过程中噪声放大的问题。
3. **保留细节**：小波变换能够分离影像的低频和高频分量，在匀色的同时保留影像中的边缘和细节信息。
4. **适合多光谱影像**：能够处理多波段、多光谱影像，较好地平衡色彩和光谱信息的差异。

###### 缺点：
1. **算法复杂**：小波变换算法相对复杂，特别是在应用于大规模影像时，计算成本较高。
2. **易受边缘效应影响**：小波变换在边缘处理时可能会产生伪影，需要额外的处理步骤来减小影响。
3. **调参要求高**：参数选择（如小波基、分解层数）对最终效果有较大影响，需要针对不同影像进行调整，增加了使用难度。





##### 基于小波变换改进的 MASK 匀光算法

(1) 仍然将原始图像分解成大小为 2<sup> (n) </sup>×2<sup> (n) </sup>的子块, 并以每个子块的平均灰度值作为小波 n 层变换后低 频系数的粗略估计值, 然后将这个粗略估计值进行 自适应非线性拉伸, 拉伸函数如公式(2): 

<img src="C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240903130243367.png" alt="image-20240903130243367" style="zoom:50%;" />

式中, x0=Average; Average 代表原始图像灰度均值;  Cmax表示小波分解后小波低频系数最大值; Cmin表示小波分解后小波低频系数最小值; xmax表示原始图像 灰度最大值; xmin表示原始图像灰度最小值; x为待变换值, 即经过步骤(1)提取出的每小块均值; δ为拉伸参数。

同时令第一至第 n 层的细节系数都为零。再作 n 次小波反变换得到背景图像。

(2) 从原始影像中减去背景图像后, 采用公式 (4)进行适当的对比度拉伸(王密 & 潘俊, 2004), 增大邻部反差。

<img src="C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240903130946506.png" alt="image-20240903130946506" style="zoom:50%;" />

改进后好处：原有的小波系数得到了自适应拉伸, 使得背景图像即能够很好的表达色调和亮度信息, 又不带有过多的细节信息, 最终得到好的匀光效果。



##### 辐射校正法

###### 优点：
1. **精确性高**：通过对影像的辐射值进行物理校正，能够减少传感器、太阳角度和大气状况等因素对影像色彩的影响。
2. **一致性好**：在多时相、多传感器影像融合时，可以确保影像色彩的整体一致性。
3. **可恢复真实地物信息**：有助于恢复地物的真实反射率，适用于定量分析。

###### 缺点：
1. **复杂性高**：辐射校正需要考虑大气校正、传感器特性等因素，过程复杂且计算量大。
2. **依赖外部数据**：通常需要大气模型、气象数据或实地观测数据作为参考，增加了工作量。
3. **不适合所有场景**：对于仅需视觉效果一致性的应用，可能过于复杂，且与快速匀色方法相比效率较低。

##### Photoshop 人工调色
`手动将参考影像中某类地物的颜色赋给待校正影像中相似的地物`
优点：灵活性好、效果好。可以随时根据中间结果进行调整。

缺点：易受处理者主观因素影响而产生误差，处理大规模影像时耗费较多的人力物力

- [x] ##### ***Wallis滤波算法***

`Wallis滤波器是一种常用于影像增强的滤波器，它能够在增加原始影像的反差的同时抑制噪声，其目的是将局部影像的灰度均值和方差映射到给定的灰度均值和方差值。它实际上是一种局部影像变换，使得影像中灰度的微小信息得到增强。这一特性使影像各区域灰度均值以及方差近似相等，从而实现影像间匀色处理。`

*使用统一的标准参数对各分块进行标准化处理*

<img src="C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240903092927968.png" alt="image-20240903092927968" style="zoom:50%;" />

优点：

（1）Wallis 匀光法能够有效实现图像各区域亮度反差分布均衡。

（2）Wallis 匀光法相比较于其他匀色方法，实现起来简单而有效，对于尺寸 较大的影像来说，在处理速度上占有很大的优势。

缺点：

（1）Wallis 匀光法在处理内部光照反差剧烈时，难以根据灰度均值自动确定合适分块作为目标分块，而人工选择光照均匀亮度适中的分块作为目标分块时， 匀光效果会受到主观因素影响，且效率不佳。 

（2）Wallis 匀光法进行分块处理会导致“块效应”的产生，影响视觉效果。

<img src="C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240903101411853.png" alt="image-20240903101411853" style="zoom:50%;" />

##### 一种基于 L0 范数平滑滤波的遥感影像底图匀色算法

首先提取底图低频信息和目标片高频信息，然后通过改进的IHS算法将两部分信息进行融合，最后得到色彩均衡的处理结果。

### 深度学习的方法【作用 优缺点】

#### 生成对抗网络

CycleGAN 

ACGAN【 设计更加稳健的U型注意力机制，并将其加入CycleGAN 构成】

CycleGAN +局部二值LBP算法（处理纹理不清晰问题）+Total Variation Loss（约束噪声）

CycleGAN 生成器网络U-net取代ResNet(保留更多细节信息，提供更好的局部 一致性)

CA-CycleGAN     生成器中加入通道注意力网络 图2

BicycleGAN   针对CycleGAN生成结果单一问题提出  基于条件遗传算法的混合模型，结合了cVAE-GAN和 cLR-GAN的优点学习两个图 像域之间的多模态映射，有助于产生更多样化的结果。

![image-20240921160311308](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240921160311308.png)

优点：

既不需要人工操作，又 能够根据输入影像数据定制化训练影像色彩一致性模型，能够保证较好的影像色 彩一致性效果





### 实验

全色影像辐射定标

![image-20240913001212997](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240913001212997.png)

图像融合前

![image-20240913001922268](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240913001922268.png)

图像融合后

![image-20240913001900195](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240913001900195.png)

直方图匹配前

![image-20240913234229320](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240913234229320.png)

参考影像

![image-20240913234330653](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240913234330653.png)

直方图匹配后

![image-20240913234109721](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240913234109721.png)







#### 下载数据集

![image-20240921154438980](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240921154438980.png)



## 20240929

#### wallis匀色的实现

##### 第一步

将影像从uint16转为uint8

灰度值范围：2的16次方——>2的八次方

##### 第二步

wallis变换前

![image-20240929015536476](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240929015536476.png)

参考影像

![image-20240929015601785](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240929015601785.png)

wallis变换后

![image-20240929015641976](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20240929015641976.png)



2024/10/19

此段代码可直接16至8位

img_org = img_org.astype(np.uint8)
infer_img = infer_img.astype(np.uint8)

但是envi中查看到GF2 uint16的数值范围为

<img src="C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20241019032707186.png" alt="image-20241019032707186" style="zoom:67%;" />

直接img.astype(np.uint8)没有对原始影像进行归一化故产生如下错误效果

![image-20241019031851094](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20241019031851094.png)

#### 为什么要归一化？

在处理图像时，尤其是将 `uint16` 类型的图像直接转换为 `uint8` 类型，可能会出现色彩不正常的现象。原因在于直接转换时会丢失 `uint16` 中较高的数值范围，导致结果图像的色彩失真。以下是详细的解释及解决方法。

### 原因
1. **数据范围差异**：
   - `uint16` 类型的图像可以包含从 `0` 到 `65535` 的数值，而 `uint8` 类型只能包含从 `0` 到 `255` 的数值。
   - 如果直接使用 `astype(np.uint8)`，会简单地将 `0` 到 `1000` 的数值映射到 `0` 到 `255` 的范围，而不会考虑这些数值之间的相对比例。

2. **数据截断**：
   - 由于 `uint8` 只能表示 `0-255`，在转换过程中大于 `255` 的所有值将被截断（变为 `255`），导致信息丢失和色彩失真。

### 解决方案
使用 **归一化** 方法将 `uint16` 图像数据映射到 `0` 到 `255` 的范围，以保持色彩的准确性和细节。

以下是实现步骤的代码示例：

```python
import numpy as np
import cv2

# 读取 uint16 图像
data_uint16 = cv2.imread('path_to_your_uint16_image.tiff', cv2.IMREAD_UNCHANGED)

# 确保图像是 uint16 类型
if data_uint16.dtype != np.uint16:
    raise ValueError("图像不是 uint16 类型！")

# 使用 Min-Max 归一化将 uint16 转换为 uint8
data_uint8 = ((data_uint16 - data_uint16.min()) / (data_uint16.max() - data_uint16.min()) * 255).astype(np.uint8)

# 保存转换后的图像
cv2.imwrite('path_to_your_output_image.png', data_uint8)

# 显示结果
cv2.imshow('Converted Image', data_uint8)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 代码解释
1. **读取图像**：确保读取的是 `uint16` 类型的图像。
2. **归一化处理**：
   - `data_uint16 - data_uint16.min()`：使得最小值变为 `0`。
   - `data_uint16.max() - data_uint16.min()`：计算当前图像的动态范围。
   - 除以动态范围并乘以 `255`，将数据范围映射到 `0` 到 `255`。
3. **数据类型转换**：最后将结果转换为 `uint8`。

### 小贴士
- **可视化效果**：归一化后的图像通常能够更好地展示细节，避免色彩失真。
- **避免过度拉伸**：如果图像中存在极端值（噪声），可能会影响归一化结果，考虑对数据进行滤波或去噪。

通过以上方式，你可以有效地将 `uint16` 图像转换为 `uint8` 而不会失去重要的视觉信息。

原始影像

![image-20241019022009736](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20241019022009736.png)

参考影像

![image-20241019022035227](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20241019022035227.png)

匀色后（分块）

![image-20241019022120617](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20241019022120617.png)

完整匀色

![image-20241019031229391](C:\Users\Renee\AppData\Roaming\Typora\typora-user-images\image-20241019031229391.png)

